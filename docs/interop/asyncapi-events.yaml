asyncapi: '2.6.0'
info:
  title: ECS Events (Audit/Async) - Skeleton
  version: 'v1'
servers:
  - url: wss://api.example.com/events
    protocol: wss
channels:
  /events/audit:
    subscribe:
      message:
        name: AuditEvent
        payload:
          $ref: '#/components/schemas/AuditEvent'
  /events/tenant:
    subscribe:
      message:
        name: TenantEvent
        payload:
          $ref: '#/components/schemas/TenantEvent'
  /events/workload:
    subscribe:
      message:
        name: WorkloadEvent
        payload:
          $ref: '#/components/schemas/WorkloadEvent'
components:
  schemas:
    EventEnvelope:
      type: object
      description: Minimal audit-ready envelope with integrity hooks
      properties:
        id: { type: string, format: uuid, description: Unique event id }
        sequence: { type: integer, description: Monotonic per-channel sequence }
        prev_hash: { type: string, description: Hash of previous envelope for chain integrity }
        correlation_id: { type: string, description: Shared id for governed action traceability }
        tenant: { type: string }
        type: { type: string, description: Event category }
        outcome: { type: string, enum: [accepted, refused, failed] }
        occurred_at: { type: string, format: date-time }
        evidence_pointer: { type: string, description: URI/hashlink to immutable evidence }
        evidence_hash: { type: string, description: Optional hash of canonical payload/evidence }
        monotonic_time_ns: { type: integer, description: Optional monotonic clock value for local ordering }
        payload: { type: object, description: Event-specific fields }
      required:
        - id
        - sequence
        - tenant
        - type
        - outcome
        - occurred_at
        - evidence_pointer
        - payload
    AuditEvent:
      allOf:
        - $ref: '#/components/schemas/EventEnvelope'
        - type: object
          description: Evidence-grade audit stream entry (aligned with WS5 evidence catalog)
    TenantEvent:
      allOf:
        - $ref: '#/components/schemas/EventEnvelope'
        - type: object
          properties:
            type:
              type: string
              enum: [created, updated, suspended, deleted]
            payload:
              type: object
              description: Tenant snapshot (authority/policy context) at event time.
          description: Tenant lifecycle/bootstrap events with evidence linkage.
    WorkloadEvent:
      allOf:
        - $ref: '#/components/schemas/EventEnvelope'
        - type: object
          properties:
            type:
              type: string
              enum: [admitted, updated, terminated]
            payload:
              type: object
              description: Envelope declaration, policy snapshot, attestation refs.
          description: Workload/envelope lifecycle events with integrity hooks.
